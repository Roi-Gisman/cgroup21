<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8" />
    <title>Movies World</title>
    <style>
        /* General Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        /* Header Styles */
        span img.title {
            display: block;
            margin: 0 auto;
            max-width: 300px;
            height: auto;
            padding: 20px 0;
        }

        /* Navigation Styles */
        .navigate {
            background-color: #2c3e50;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

            .nav-buttons button {
                background-color: #3498db;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.3s ease;
            }

                .nav-buttons button:hover {
                    background-color: #2980b9;
                    transform: translateY(-2px);
                }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        #userGreeting {
            font-size: 1.1em;
        }

        #logoutBtn, #editBtn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            #logoutBtn:hover, #editBtn:hover {
                background-color: #c0392b;
            }

        #editBtn {
            background-color: #2ecc71;
        }

            #editBtn:hover {
                background-color: #27ae60;
            }

        /* Main Content Styles */
        .mainDiv {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .btnLoadMovies {
            text-align: center;
            margin-bottom: 30px;
        }

        #loadMovies {
            background-color: #9b59b6;
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

            #loadMovies:hover {
                background-color: #8e44ad;
                transform: translateY(-2px);
            }

        /* Add Movie Button Container */
        .addMovie {
            display: none; /* Hidden by default (controlled by JS) */
            margin-left: 20px; /* Spacing from other elements */
        }
        /* Add Movie Button Styles */
        #addMovieBTN {
            background-color: #2ecc71; /* Green color matching your design system */
            color: white;
            border: none;
            padding: 12px 25px;
            font-size: 1.1em;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

            #addMovieBTN:hover {
                background-color: #27ae60; /* Darker green on hover */
                transform: translateY(-2px);
                box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            }

            #addMovieBTN:active {
                transform: translateY(0);
            }

        /* Advanced Search Styles */
        .advencedSearch {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .searchBy {
            display: flex;
            align-items: center;
            gap: 10px;
        }

            .searchBy input {
                padding: 10px 15px;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 1em;
            }

            .searchBy button {
                background-color: #3498db;
                color: white;
                border: none;
                padding: 10px 15px;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

                .searchBy button:hover {
                    background-color: #2980b9;
                }

        /* Movies Grid Styles */
        .moviesDetail {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .movieCube {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

            .movieCube:hover {
                transform: translateY(-5px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            }

        .divImg {
            position: relative;
            width: 100%;
            height: 400px;
            overflow: hidden;
        }

            .divImg img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.5s ease;
            }

        .movieCube:hover .divImg img {
            transform: scale(1.05);
        }

        .movie-buttons {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: rgba(0,0,0,0.7);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .movieCube:hover .movie-buttons {
            opacity: 1;
        }

        .movie-buttons button {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .addToCart {
            background-color: #2ecc71;
            color: white;
        }

            .addToCart:hover {
                background-color: #27ae60;
            }

        .deleteMovieBTN {
            background-color: #e74c3c;
            color: white;
        }

            .deleteMovieBTN:hover {
                background-color: #c0392b;
            }

        .movieCube h2 {
            margin: 15px;
            font-size: 1.3em;
            color: #2c3e50;
        }

        .movie-subtitle {
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            margin-bottom: 15px;
            color: #7f8c8d;
        }

            .movie-subtitle span {
                font-size: 0.9em;
            }

        .movieCube p {
            padding: 0 15px;
            margin-bottom: 15px;
            color: #555;
            font-size: 0.95em;
        }

        .dividingLine {
            border: none;
            height: 1px;
            background-color: #ecf0f1;
            margin: 0 15px 15px;
        }

        .extra {
            padding: 0 15px 15px;
        }

            .extra h6 {
                margin: 5px 0;
                color: #7f8c8d;
                font-size: 0.85em;
            }

            .extra span {
                font-size: 0.95em;
            }

        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            gap: 5px;
        }

        .pagination-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background-color: white;
            color: #3498db;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .pagination-btn:hover:not(.active) {
                background-color: #f1f1f1;
            }

            .pagination-btn.active {
                background-color: #3498db;
                color: white;
                border-color: #3498db;
            }

            .pagination-btn:disabled {
                opacity: 0.5;
                cursor: not-allowed;
            }

        /* Responsive Design */
        @media (max-width: 768px) {
            .navigate {
                flex-direction: column;
                gap: 15px;
            }

            .nav-buttons {
                width: 100%;
                justify-content: center;
            }

            .user-section {
                width: 100%;
                justify-content: center;
            }

            .advencedSearch {
                flex-direction: column;
                align-items: stretch;
            }

            .searchBy {
                flex-direction: column;
                align-items: stretch;
            }

            .moviesDetail {
                grid-template-columns: 1fr;
            }
            .addMovie {
                margin-left: 0;
                margin-top: 15px;
            }

            #addMovieBTN {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .mainDiv {
                padding: 0 15px;
            }
            .nav-buttons {
                flex-direction: column;
            }

                .nav-buttons button {
                    width: 100%;
                }

            .btnLoadMovies {
                display: flex;
                flex-direction: column;
                gap: 10px;
            }

            #loadMovies {
                width: 100%;
                margin-left: 0;
                padding: 10px 20px;
                font-size: 1em;
            }
            #addMovieBTN {
                padding: 10px 20px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="scripts/ajaxCalls.js"></script>

    <!-- logo -->
    <span>
        <img class="title" src="images/moviesWorld.png" />
    </span>

    <!-- Navigation -->
    <div class="navigate">
        <div class="nav-buttons">
            <a href="index.html"><button class="Homebtn">Home</button></a>
            <a href="myMovies.html"><button class="MyMoviesbtn">My Movies</button></a>
            <a href="loginPage.html"><button class="Loginbtn">Login</button></a>
        </div>
        <div class="user-section">
            <span id="userGreeting">Hello guest 👋</span>
            <button id="logoutBtn" style="display: none;">Logout</button>
            <button id="editBtn" style="display: none;">Edit my profile</button>
        </div>
    </div>

    <!-- Main -->
    <div class="mainDiv">
        <div class="btnLoadMovies">
            <button id="loadMovies">Load Movies</button>
        </div>
        <div class="addMovie" style="display:none">
            <button id="addMovieBTN">+ Add Movie</button>
        </div>
        <div class="advencedSearch" style="display: none;">
            <span class="searchBy">
                <input type="text" class="titleText" placeholder="search by title">
            </span>
            <span class="searchBy">
                <button id="btnTitle">search by title</button>
            </span>
            <span class="searchBy">
                <input type="date" class="starDateText" placeholder="search by start date">
            </span>

            <span class="searchBy">
                <input type="date" class="endDateText" placeholder="search by end date">
            </span>
            <span class="searchBy">
                <button id="btnRangeDate">search by date</button>
            </span>
        </div>
        <div class="moviesDetail"></div>
    </div>
    <!-- Scripts -->
    <script>
        //upload site
        var moviesServer;
        var user;
        var isLogin;
        $(document).ready(function () {
            uploadUser();
            $("#loadMovies").click(loadMoviesFromServer);
            $(".moviesDetail").on("click", ".addToCart", sendToServer);
            $(".moviesDetail").on("click", ".deleteMovieBTN", delMovieServer);
            $("#btnTitle").on("click", searchTitle);
            $("#btnRangeDate").on("click", searchStartDate);
        });


        //hello messege for user or guest user
        function uploadUser() {
            const greetingEl = document.getElementById("userGreeting");
            const logoutBtn = document.getElementById("logoutBtn");
            const editBtn = document.getElementById("editBtn");

            const userStr = localStorage.getItem("user");
            if (userStr) {
                user = JSON.parse(userStr);
                greetingEl.textContent = `Hello ${user.name} 👋`;
                logoutBtn.style.display = "inline-block";
                editBtn.style.display = "inline-block";
                isLogin = true;

                // כפתור עריכה
                editBtn.addEventListener("click", function () {
                    window.location.href = "editProfilePage.html";
                });

            } else {
                greetingEl.textContent = "Hello guest 👋";
                logoutBtn.style.display = "none";
                editBtn.style.display = "none";
                isLogin = false;
            }

            // כפתור יציאה
            logoutBtn.addEventListener("click", function () {
                localStorage.removeItem("user"); // מוחק את המשתמש
                window.location.href = "index.html";
            });
        }

        //load movies from server
        function loadMoviesFromServer() {
            const url = `https://localhost:7260/api/movies/allMovies`;
            ajaxCall("GET", url, null, SCB, ECB);

            function SCB(res) {
                if (res == null) {
                    console.log("Movies upload is failed");
                    return;
                }
                moviesServer = res;
                loadMovies();
            }

            function ECB(err) {
                console.log("Movies upload is failed", err); 
            }
        }

        function loadMovies() {
            let moviesDetail = document.querySelector(".moviesDetail");
            moviesDetail.innerHTML = "";
            let btnLoadMovies = document.querySelector(".btnLoadMovies");
            btnLoadMovies.innerHTML = "";
            let searchDiv = document.querySelector(".advencedSearch");
            searchDiv.style.display = "inline-block";

            if (isLogin) {
                document.querySelector('.addMovie').style.display = 'block';
            }

            const moviesPerPage = 15;
            let currentPage = 1;

            function renderMovies() {
                moviesDetail.innerHTML = "";
                btnLoadMovies.innerHTML = "";
                const startIndex = (currentPage - 1) * moviesPerPage;
                const endIndex = startIndex + moviesPerPage;
                const paginatedMovies = moviesServer.slice(startIndex, endIndex);

                paginatedMovies.forEach(movie => {
                    let movieCube = document.createElement("div");
                    movieCube.classList.add("movieCube");

                    // Image
                    let divImg = document.createElement("div");
                    divImg.classList.add("divImg");
                    let img = document.createElement("img");
                    img.src = movie.primaryImage || 'placeholder.jpg'; 
                    img.alt = movie.primaryTitle; 
                    divImg.appendChild(img);

                    // Buttons (only for logged in users)
                    if (isLogin) {
                        let divButtons = document.createElement("div");
                        divButtons.classList.add("movie-buttons");

                        let addCartBTN = document.createElement("button");
                        addCartBTN.innerText = "Rent me";
                        addCartBTN.classList.add('addToCart');
                        addCartBTN.dataset.movie = JSON.stringify(movie);

                        let deleteBTN = document.createElement("button");
                        deleteBTN.innerText = "Delete";
                        deleteBTN.classList.add('deleteMovieBTN');
                        deleteBTN.dataset.movie = JSON.stringify(movie);

                        divButtons.appendChild(addCartBTN);
                        divButtons.appendChild(deleteBTN);
                        divImg.appendChild(divButtons);
                    }

                    movieCube.appendChild(divImg);

                    // Title
                    let title = document.createElement("h2");
                    title.textContent = movie.primaryTitle;
                    movieCube.appendChild(title);

                    // Subtitle
                    let subTitle = document.createElement("div");
                    subTitle.classList.add("movie-subtitle");

                    let release = document.createElement("span");
                    release.textContent = `${movie.year}`;
                    release.classList.add("block");
                    subTitle.appendChild(release);

                    let runtime = document.createElement("span");
                    runtime.textContent = `${movie.runtimeMinutes || 'N/A'} min`; 
                    runtime.classList.add("block");
                    subTitle.appendChild(runtime);

                    let rating = document.createElement("span");
                    rating.textContent = `${movie.averageRating || '0'}/10`; 
                    rating.classList.add("block");
                    subTitle.appendChild(rating);

                    movieCube.appendChild(subTitle);

                    // Description
                    if (movie.description) {
                        let description = document.createElement("p");
                        description.textContent = movie.description;
                        movieCube.appendChild(description);
                    }

                    // Dividing line
                    let dividingLine1 = document.createElement("hr");
                    dividingLine1.classList.add("dividingLine");
                    movieCube.appendChild(dividingLine1);

                    // Genres
                    if (movie.genres) {
                        let genresTags = document.createElement("div");
                        let tag = document.createElement("span");
                        tag.classList.add("block");
                        tag.textContent = "Genres: " + movie.genres;
                        genresTags.appendChild(tag);
                        movieCube.appendChild(genresTags);

                        // Dividing line
                        let dividingLine2 = document.createElement("hr");
                        dividingLine2.classList.add("dividingLine");
                        movieCube.appendChild(dividingLine2);
                    }

                    // Additional Info
                    let extra = document.createElement("div");
                    extra.classList.add("extra");

                    // Language
                    if (movie.language) {
                        let divLanguage = document.createElement("div");
                        divLanguage.classList.add("block");
                        let LanguageTitle = document.createElement("h6");
                        LanguageTitle.textContent = "Language:";
                        divLanguage.appendChild(LanguageTitle);
                        let LanguageSpan = document.createElement("span");
                        LanguageSpan.textContent = movie.language;
                        divLanguage.appendChild(LanguageSpan);
                        extra.appendChild(divLanguage);
                    }

                    // Budget
                    if (movie.budget) {
                        let divBuget = document.createElement("div");
                        divBuget.classList.add("block");
                        let budgetTitle = document.createElement("h6");
                        budgetTitle.innerText = "Budget:";
                        divBuget.appendChild(budgetTitle);
                        let budgetSpan = document.createElement("span");
                        budgetSpan.innerText = `$${movie.budget.toLocaleString()}`; // הוספתי פורמט מספר
                        divBuget.appendChild(budgetSpan);
                        extra.appendChild(divBuget);
                    }

                    // Votes
                    if (movie.numVotes) {
                        let divVotes = document.createElement("div");
                        divVotes.classList.add("block");
                        let votesTitle = document.createElement("h6");
                        votesTitle.innerText = "Votes:";
                        divVotes.appendChild(votesTitle);
                        let votesSpan = document.createElement("span");
                        votesSpan.innerText = movie.numVotes.toLocaleString(); // הוספתי פורמט מספר
                        divVotes.appendChild(votesSpan);
                        extra.appendChild(divVotes);
                    }

                    movieCube.appendChild(extra);
                    moviesDetail.appendChild(movieCube);
                });
            }

            function setupPagination() {
                const paginationContainer = document.createElement("div");
                paginationContainer.classList.add("pagination");

                const pageCount = Math.ceil(moviesServer.length / moviesPerPage); 

                // Previous Button
                const prevButton = document.createElement('button');
                prevButton.innerText = 'Previous';
                prevButton.classList.add('pagination-btn');
                prevButton.disabled = (currentPage === 1);
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderMovies(); 
                        setupPagination();
                    }
                });
                paginationContainer.appendChild(prevButton);

                // Page Number Buttons
                const maxVisiblePages = 5; 
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(pageCount, startPage + maxVisiblePages - 1);

                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }

                if (startPage > 1) {
                    const firstPageButton = document.createElement('button');
                    firstPageButton.innerText = '1';
                    firstPageButton.classList.add('pagination-btn');
                    firstPageButton.addEventListener('click', () => {
                        currentPage = 1;
                        renderMovies();
                        setupPagination();
                    });
                    paginationContainer.appendChild(firstPageButton);

                    if (startPage > 2) {
                        const ellipsis = document.createElement('span');
                        ellipsis.innerText = '...';
                        paginationContainer.appendChild(ellipsis);
                    }
                }

                for (let i = startPage; i <= endPage; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.innerText = i;
                    pageButton.classList.add('pagination-btn');
                    if (i === currentPage) {
                        pageButton.classList.add('active');
                    }
                    pageButton.addEventListener('click', () => {
                        currentPage = i;
                        renderMovies();
                        setupPagination();
                    });
                    paginationContainer.appendChild(pageButton);
                }

                if (endPage < pageCount) {
                    if (endPage < pageCount - 1) {
                        const ellipsis = document.createElement('span');
                        ellipsis.innerText = '...';
                        paginationContainer.appendChild(ellipsis);
                    }

                    const lastPageButton = document.createElement('button');
                    lastPageButton.innerText = pageCount;
                    lastPageButton.classList.add('pagination-btn');
                    lastPageButton.addEventListener('click', () => {
                        currentPage = pageCount;
                        renderMovies();
                        setupPagination();
                    });
                    paginationContainer.appendChild(lastPageButton);
                }

                // Next Button
                const nextButton = document.createElement('button');
                nextButton.innerText = 'Next';
                nextButton.classList.add('pagination-btn');
                nextButton.disabled = (currentPage === pageCount);
                nextButton.addEventListener('click', () => {
                    if (currentPage < pageCount) {
                        currentPage++;
                        renderMovies(); 
                        setupPagination();
                    }
                });
                paginationContainer.appendChild(nextButton);

                const oldPagination = document.querySelector(".pagination");
                if (oldPagination) {
                    oldPagination.remove();
                }
                moviesDetail.parentNode.insertBefore(paginationContainer, moviesDetail.nextSibling);
            }

            // Initial render
            if (moviesServer && moviesServer.length > 0) {
                renderMovies();
                setupPagination();
            }
        }
        //add movies to server
        function loadSCB(res) {
            console.log("success");
            return true;
        }

        function loadECB(res) {
            console.log("error");
            return false;
        }

        function sendToServer() {
            const newMovie = JSON.parse(this.dataset.movie);
            localStorage.setItem("movieId", JSON.stringify(newMovie.id));
            window.location.href = `RentMovie.html`;

        }

        function delMovieServer() {
            const movieId = JSON.parse(this.dataset.movie).id;
            const url = `https://localhost:7260/api/movies/${movieId}`;

            ajaxCall("DELETE", url, null, delSCB, delECB);
            function delSCB(res) {
                loadMovies();
                window.location.reload();
                return true;
            }
            function delECB(res) {
                console.log("movie is not delete" + res);
                return false;
            }
        }

        //searches
        function searchTitle() {
            const title = $(".titleText").val();
            const url = `https://localhost:7260/api/movies/getByTitle?title=${title}`;
            ajaxCall("GET", url, null, searchSCB, searchECB);
        }

        function searchStartDate() {
            const startDate = $(".starDateText").val();
            const endDate = $(".endDateText").val();
            console.log(startDate);
            console.log(endDate);

            const url = `https://localhost:7260/api/movies/searchByDate/from/${startDate}/until/${endDate}`;

            ajaxCall("GET", url, null, searchSCB, searchECB);
        }
        function searchSCB(response) {
            console.log(response);
            moviesServer = [];

            if (!Array.isArray(response)) {
                console.error("Expected array but received:", typeof response);
                return;
            }

            response.forEach(movie => {
                moviesServer.push({
                    url: movie.url || "",
                    primaryTitle: movie.primaryTitle || "",
                    description: movie.description || "",
                    primaryImage: movie.primaryImage || "",
                    year: movie.startYear || 1900,
                    releaseDate: movie.releaseDate || "1900-01-01",
                    language: movie.language || "Unknown",
                    budget: movie.budget || 0,
                    grossWorldwide: movie.grossWorldwide || 0,
                    genres: Array.isArray(movie.genres) ? movie.genres.join(",") : "",
                    isAdult: movie.isAdult || false,
                    runtimeMinutes: movie.runtimeMinutes || 0,
                    averageRating: movie.averageRating || 0,
                    numVotes: movie.numVotes || 0
                });
            });
            loadMovies();
        }
        function searchECB(err) {
            alert("error in the search function");
            console.error(err);
        }

        
        

        //for (let movie of movies) {
        //    //const url = `https://proj.ruppin.ac.il/cgroup21/test2/tar1/api/movies`;
        //    const url = `https://localhost:7260/api/movies`;
        //    const dataMovie = {
        //        url: movie.url || "",
        //        primaryTitle: movie.primaryTitle || "",
        //        description: movie.description || "",
        //        primaryImage: movie.primaryImage || "",
        //        year: movie.startYear || 1900,
        //        releaseDate: movie.releaseDate || "1900-01-01",
        //        language: movie.language || "Unknown",
        //        budget: movie.budget || 0,
        //        grossWorldwide: movie.grossWorldwide || 0,
        //        genres: Array.isArray(movie.genres) ? movie.genres.join(",") : "",
        //        isAdult: movie.isAdult || false,
        //        runtimeMinutes: movie.runtimeMinutes || 0,
        //        averageRating: movie.averageRating || 0,
        //        numVotes: movie.numVotes || 0,
        //        priceToRent:movie.priceToRent
        //    }
        //    console.log(movie);
        //    console.log(dataMovie);
        //    ajaxCall("POST", url, JSON.stringify(dataMovie), SCB, ECB);
        //    function SCB(res) {
        //        console.log(res);
        //    }
        //    function ECB(res) {
        //        console.log("moveis up load is failed");

        //    }
        

    </script>

</body>
</html>