<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <style>
        /* General Styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        /* Header Styles */
        span img.title {
            display: block;
            margin: 0 auto;
            max-width: 300px;
            height: auto;
            padding: 20px 0;
        }

        /* Navigation Styles */
        .navigate {
            background-color: #2c3e50;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .nav-buttons {
            display: flex;
            gap: 10px;
        }

            .nav-buttons button {
                background-color: #3498db;
                color: white;
                border: none;
                padding: 10px 20px;
                border-radius: 4px;
                cursor: pointer;
                font-weight: bold;
                transition: all 0.3s ease;
            }

                .nav-buttons button:hover {
                    background-color: #2980b9;
                    transform: translateY(-2px);
                }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
            color: white;
        }

        #userGreeting {
            font-size: 1.1em;
        }

        #logoutBtn, #editBtn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            #logoutBtn:hover, #editBtn:hover {
                background-color: #c0392b;
            }

        #editBtn {
            background-color: #2ecc71;
        }

            #editBtn:hover {
                background-color: #27ae60;
            }

        /* Main Content Styles */
        .mainDiv {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .subTitle h2 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 25px;
            font-size: 1.5em;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        /* Movies Grid Styles */
        .moviesDetail {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .movieCube {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            padding-bottom: 60px; /* Space for buttons */
        }

            .movieCube:hover {
                transform: translateY(-5px);
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            }

        .divImg {
            position: relative;
            width: 100%;
            height: 400px;
            overflow: hidden;
        }

            .divImg img {
                width: 100%;
                height: 100%;
                object-fit: cover;
                transition: transform 0.5s ease;
            }

        .movieCube:hover .divImg img {
            transform: scale(1.05);
        }

        /* Delete Button */
        .delFromCart {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 2;
        }

            .delFromCart:hover {
                background-color: #c0392b;
                transform: scale(1.1);
            }

        /* Movie Content */
        .movieCube h2 {
            margin: 15px;
            font-size: 1.3em;
            color: #2c3e50;
        }

        .movie-subtitle {
            display: flex;
            justify-content: space-between;
            padding: 0 15px;
            margin-bottom: 15px;
            color: #7f8c8d;
        }

            .movie-subtitle span {
                font-size: 0.9em;
            }

        .movieCube p {
            padding: 0 15px;
            margin-bottom: 15px;
            color: #555;
            font-size: 0.95em;
        }

        .dividingLine {
            border: none;
            height: 1px;
            background-color: #ecf0f1;
            margin: 0 15px 15px;
        }

        .extra {
            padding: 0 15px 15px;
        }

            .extra h6 {
                margin: 5px 0;
                color: #7f8c8d;
                font-size: 0.85em;
            }

            .extra span {
                font-size: 0.95em;
            }

        /* Action Buttons */
        .sendMovieToUser {
            position: absolute;
            bottom: 15px;
            left: 15px;
            right: 15px;
            background-color: #9b59b6;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

            .sendMovieToUser:hover {
                background-color: #8e44ad;
            }

        /* User Selection Form */
        .userSelectionForm {
            position: absolute;
            bottom: 15px;
            left: 15px;
            right: 15px;
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 4px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

            .userSelectionForm label {
                display: block;
                margin-bottom: 8px;
                font-size: 0.9em;
                color: #2c3e50;
            }

            .userSelectionForm select {
                width: 100%;
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
                margin-bottom: 10px;
            }

            .userSelectionForm button {
                background-color: #2ecc71;
                color: white;
                border: none;
                padding: 8px 15px;
                border-radius: 4px;
                cursor: pointer;
                transition: all 0.3s ease;
            }

                .userSelectionForm button:hover {
                    background-color: #27ae60;
                }

        /* Pagination Styles */
        .pagination {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            gap: 5px;
        }

        .pagination-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background-color: white;
            color: #3498db;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }

            .pagination-btn:hover:not(.active):not(:disabled) {
                background-color: #3498db;
                color: white;
            }

            .pagination-btn.active {
                background-color: #3498db;
                color: white;
                border-color: #3498db;
            }

            .pagination-btn:disabled {
                color: #aaa;
                cursor: not-allowed;
                background-color: #f9f9f9;
            }

        /* Responsive Design */
        @media (max-width: 768px) {
            .navigate {
                flex-direction: column;
                gap: 15px;
            }

            .nav-buttons {
                width: 100%;
                justify-content: center;
            }

            .user-section {
                width: 100%;
                justify-content: center;
            }

            .moviesDetail {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }

            .divImg {
                height: 350px;
            }
        }

        @media (max-width: 480px) {
            span img.title {
                max-width: 250px;
            }

            .mainDiv {
                padding: 0 15px;
            }

            .moviesDetail {
                grid-template-columns: 1fr;
            }

            .divImg {
                height: 300px;
            }

            .pagination {
                flex-wrap: wrap;
            }

            .pagination-btn {
                padding: 6px 12px;
            }
        }
    </style>

</head>
<body>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js" integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="scripts/ajaxCalls.js"></script>

    <!-- logo -->
    <span>
        <img class="title" src="images/moviesWorld.png" />
    </span>

    <!-- Navigation -->
    <div class="navigate">
        <div class="nav-buttons">
            <a href="index.html"><button class="Homebtn">Home</button></a>
            <a href="myMovies.html"><button class="MyMoviesbtn">My Movies</button></a>
            <a href="loginPage.html"><button class="Loginbtn">Login</button></a>
        </div>
        <div class="user-section">
            <span id="userGreeting">Hello guest 👋</span>
            <button id="logoutBtn" style="display: none;">Logout</button>
            <button id="editBtn" style="display: none;">Edit my profile</button>
        </div>
    </div>

    <div class="mainDiv">
        <!-- Main -->
        <div class="subTitle"><h2>My Movies</h2></div>
        <div class="moviesDetail"></div>
    </div>
    <script>
        var moviesServer;
        var user;
        var isLogin;

        $(document).ready(function () {
            uploadUser();
            getMoviesCart();
            $(document).on("click", ".delFromCart", delFromCart);
            $(".formUserNum").submit(function (e) {
                e.preventDefault();
                sendMovieToUserNum();
            });

        });
        function delFromCart() {
            const movie = $(this).data("movie");
            const otherUserId = $("#userInput").val();

            const url = `https://localhost:7260/api/movies/deleteFromCart/userId/${otherUserId}/movieId/${savedMovieIds}`;

            ajaxCall("GET", url, null,
                function (moviesData) {
                    console.log("The movie deleted from the cart");
                },
                function (err) {
                    console.log("the movie isn't deleted");
                });
            window.location.reload();
        }

        function getMoviesCart() {
            const url = `https://localhost:7260/api/movies/getCart?userId=${user.id}`;

            ajaxCall("GET", url, null,
                function (moviesData) {
                    moviesServer = moviesData;
                    loadMovies();
                },
                function (err) {
                    console.log("The movies are not upload from the server");
                });
        }
        function uploadUser() {
            const greetingEl = document.getElementById("userGreeting");
            const logoutBtn = document.getElementById("logoutBtn");
            const editBtn = document.getElementById("editBtn");

            const userStr = localStorage.getItem("user");
            if (userStr) {
                user = JSON.parse(userStr);
                greetingEl.textContent = `Hello ${user.name} 👋`;
                logoutBtn.style.display = "inline-block";
                editBtn.style.display = "inline-block";
                isLogin = true;

                editBtn.addEventListener("click", function () {
                    window.location.href = "editProfilePage.html";
                });

            } else {
                greetingEl.textContent = "Hello guest 👋";
                logoutBtn.style.display = "none";
                editBtn.style.display = "none";
                isLogin = false;
            }

            // כפתור יציאה
            logoutBtn.addEventListener("click", function () {
                localStorage.removeItem("user"); 
                window.location.href = "index.html";
            });
        }

        function loadMovies() {
            let moviesDetail = document.querySelector(".moviesDetail");
            moviesDetail.innerHTML = "";

            const moviesPerPage = 15;
            let currentPage = 1;

            function renderMovies() {
                moviesDetail.innerHTML = "";
                const startIndex = (currentPage - 1) * moviesPerPage;
                const endIndex = startIndex + moviesPerPage;
                const paginatedMovies = moviesServer.slice(startIndex, endIndex);

                paginatedMovies.forEach(movie => {
                    let movieCube = document.createElement("div");
                    movieCube.classList.add("movieCube");

                    // Image
                    let divImg = document.createElement("div");
                    divImg.classList.add("divImg");
                    let img = document.createElement("img");
                    img.src = movie.primaryImage || 'placeholder.jpg';
                    img.alt = movie.primaryTitle;
                    divImg.appendChild(img);

                    //delete from cart
                    let delFromCartBTN = document.createElement("button");
                    delFromCartBTN.innerText = "X";
                    delFromCartBTN.classList.add("delFromCart");
                    $(delFromCartBTN).data("movie", movie);
                    divImg.appendChild(delFromCartBTN);

                    movieCube.appendChild(divImg);

                    // Title
                    let title = document.createElement("h2");
                    title.textContent = movie.primaryTitle;
                    movieCube.appendChild(title);

                    // Subtitle
                    let subTitle = document.createElement("div");
                    subTitle.classList.add("movie-subtitle");

                    let release = document.createElement("span");
                    release.textContent = `${movie.year}`;
                    release.classList.add("block");
                    subTitle.appendChild(release);

                    let runtime = document.createElement("span");
                    runtime.textContent = `${movie.runtimeMinutes || 'N/A'} min`;
                    runtime.classList.add("block");
                    subTitle.appendChild(runtime);

                    let rating = document.createElement("span");
                    rating.textContent = `${movie.averageRating || '0'}/10`;
                    rating.classList.add("block");
                    subTitle.appendChild(rating);

                    movieCube.appendChild(subTitle);

                    // Description
                    if (movie.description) {
                        let description = document.createElement("p");
                        description.textContent = movie.description;
                        movieCube.appendChild(description);
                    }

                    // Dividing line
                    let dividingLine1 = document.createElement("hr");
                    dividingLine1.classList.add("dividingLine");
                    movieCube.appendChild(dividingLine1);

                    // Genres
                    if (movie.genres) {
                        let genresTags = document.createElement("div");
                        let tag = document.createElement("span");
                        tag.classList.add("block");
                        tag.textContent = "Genres: " + movie.genres;
                        genresTags.appendChild(tag);
                        movieCube.appendChild(genresTags);

                        // Dividing line
                        let dividingLine2 = document.createElement("hr");
                        dividingLine2.classList.add("dividingLine");
                        movieCube.appendChild(dividingLine2);
                    }

                    // Additional Info
                    let extra = document.createElement("div");
                    extra.classList.add("extra");

                    // Language
                    if (movie.language) {
                        let divLanguage = document.createElement("div");
                        divLanguage.classList.add("block");
                        let LanguageTitle = document.createElement("h6");
                        LanguageTitle.textContent = "Language:";
                        divLanguage.appendChild(LanguageTitle);
                        let LanguageSpan = document.createElement("span");
                        LanguageSpan.textContent = movie.language;
                        divLanguage.appendChild(LanguageSpan);
                        extra.appendChild(divLanguage);
                    }

                    // Budget
                    if (movie.budget) {
                        let divBuget = document.createElement("div");
                        divBuget.classList.add("block");
                        let budgetTitle = document.createElement("h6");
                        budgetTitle.innerText = "Budget:";
                        divBuget.appendChild(budgetTitle);
                        let budgetSpan = document.createElement("span");
                        budgetSpan.innerText = `$${movie.budget.toLocaleString()}`; // הוספתי פורמט מספר
                        divBuget.appendChild(budgetSpan);
                        extra.appendChild(divBuget);
                    }

                    // Votes
                    if (movie.numVotes) {
                        let divVotes = document.createElement("div");
                        divVotes.classList.add("block");
                        let votesTitle = document.createElement("h6");
                        votesTitle.innerText = "Votes:";
                        divVotes.appendChild(votesTitle);
                        let votesSpan = document.createElement("span");
                        votesSpan.innerText = movie.numVotes.toLocaleString(); // הוספתי פורמט מספר
                        divVotes.appendChild(votesSpan);
                        extra.appendChild(divVotes);
                    }

                    movieCube.appendChild(extra);

                    // create form od send movie to another users
                    let sendMovieToUserBTN = document.createElement("button");
                    sendMovieToUserBTN.innerText = "Send movie to friend";
                    sendMovieToUserBTN.classList.add("sendMovieToUser");
                    $(sendMovieToUserBTN).data("movie", movie);
                    movieCube.appendChild(sendMovieToUserBTN);

                    let userSelectionForm = document.createElement("div");
                    userSelectionForm.classList.add("userSelectionForm");
                    userSelectionForm.style.display = "none";

                    let selectLabel = document.createElement("label");
                    selectLabel.textContent = "Select friend:";
                    userSelectionForm.appendChild(selectLabel);

                    let select = document.createElement("select");
                    select.id = "userSelect";
                    userSelectionForm.appendChild(select);

                    let submitBtn = document.createElement("button");
                    submitBtn.type = "button";
                    submitBtn.textContent = "Send";
                    userSelectionForm.appendChild(submitBtn);

                    movieCube.appendChild(userSelectionForm);

                    //after click on button the user get dropdown of all users
                    sendMovieToUserBTN.addEventListener("click", function () {
                        const url = `https://proj.ruppin.ac.il/cgroup21/test2/tar1/api/users/allUsers`;

                        ajaxCall("GET", url, null,
                            function (users) {
                                select.innerHTML = '';
                                users.forEach(user => {
                                    let option = document.createElement("option");
                                    option.value = user.id;
                                    option.textContent = user.name;
                                    select.appendChild(option);
                                });
                                userSelectionForm.style.display = "block";
                            },
                            function (error) {
                                console.error("Error fetching users:", error);
                                alert("Failed to load user list. Please try again.");
                            }
                        );
                    });

                    // send the movie to anther user
                    submitBtn.addEventListener("click", function () {
                        const selectedUserId = select.value;
                        const selectedUserName = select.options[select.selectedIndex].text;
                        const movieData = $(sendMovieToUserBTN).data("movie");

                        const url = `https://proj.ruppin.ac.il/cgroup21/test2/tar1/api/movies/insertMovieToCart/userId/${selectedUserId}/movieId/${movieData.id}`;

                        ajaxCall("POST", url, null,
                            function (response) {
                                alert(`Movie successfully sent to ${selectedUserName}!`);
                                userSelectionForm.style.display = "none";
                            },
                            function (error) {
                                console.error("Error sending movie:", error);
                                alert("Failed to send movie. Please try again.");
                            }
                        );
                        delFromCart();
                    });

                    moviesDetail.appendChild(movieCube);
                });
                document.body.appendChild(mainDivMovies);

            }

            function setupPagination() {
                const paginationContainer = document.createElement("div");
                paginationContainer.classList.add("pagination");

                const pageCount = Math.ceil(moviesServer.length / moviesPerPage);

                // Previous Button
                const prevButton = document.createElement('button');
                prevButton.innerText = 'Previous';
                prevButton.classList.add('pagination-btn');
                prevButton.disabled = (currentPage === 1);
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderMovies();
                        setupPagination();
                    }
                });
                paginationContainer.appendChild(prevButton);

                // Page Number Buttons
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - 2);
                let endPage = Math.min(pageCount, startPage + maxVisiblePages - 1);

                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }

                if (startPage > 1) {
                    const firstPageButton = document.createElement('button');
                    firstPageButton.innerText = '1';
                    firstPageButton.classList.add('pagination-btn');
                    firstPageButton.addEventListener('click', () => {
                        currentPage = 1;
                        renderMovies();
                        setupPagination();
                    });
                    paginationContainer.appendChild(firstPageButton);

                    if (startPage > 2) {
                        const ellipsis = document.createElement('span');
                        ellipsis.innerText = '...';
                        paginationContainer.appendChild(ellipsis);
                    }
                }

                for (let i = startPage; i <= endPage; i++) {
                    const pageButton = document.createElement('button');
                    pageButton.innerText = i;
                    pageButton.classList.add('pagination-btn');
                    if (i === currentPage) {
                        pageButton.classList.add('active');
                    }
                    pageButton.addEventListener('click', () => {
                        currentPage = i;
                        renderMovies();
                        setupPagination();
                    });
                    paginationContainer.appendChild(pageButton);
                }

                if (endPage < pageCount) {
                    if (endPage < pageCount - 1) {
                        const ellipsis = document.createElement('span');
                        ellipsis.innerText = '...';
                        paginationContainer.appendChild(ellipsis);
                    }

                    const lastPageButton = document.createElement('button');
                    lastPageButton.innerText = pageCount;
                    lastPageButton.classList.add('pagination-btn');
                    lastPageButton.addEventListener('click', () => {
                        currentPage = pageCount;
                        renderMovies();
                        setupPagination();
                    });
                    paginationContainer.appendChild(lastPageButton);
                }

                // Next Button
                const nextButton = document.createElement('button');
                nextButton.innerText = 'Next';
                nextButton.classList.add('pagination-btn');
                nextButton.disabled = (currentPage === pageCount);
                nextButton.addEventListener('click', () => {
                    if (currentPage < pageCount) {
                        currentPage++;
                        renderMovies();
                        setupPagination();
                    }
                });
                paginationContainer.appendChild(nextButton);

                const oldPagination = document.querySelector(".pagination");
                if (oldPagination) {
                    oldPagination.remove();
                }
                moviesDetail.parentNode.insertBefore(paginationContainer, moviesDetail.nextSibling);
            }

            // Initial render
            if (moviesServer && moviesServer.length > 0) {
                renderMovies();
                setupPagination();
            }
        }
    </script>
</body>
</html>